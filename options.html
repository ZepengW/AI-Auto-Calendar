<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AI Auto Calendar 设置</title>
    <style>
        :root {
            --brand: #0b74de;
            --bg: #f6f8fb;
            --card: #ffffff;
            --border: #e6edf5;
            --text: #0f172a;
            --muted: #64748b;
        }
        html, body { height: 100%; }
        body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; color: var(--text); background: var(--bg); }
        .container { max-width: 980px; margin: 0 auto; padding: 18px 16px 40px; }
        .page-header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom: 14px; }
        .page-title { display:flex; align-items:center; gap:10px; margin:0; font-size: 22px; letter-spacing:.3px; }
        .subtle { color: var(--muted); }
    .header-actions { display:flex; align-items:center; gap:10px; flex-wrap: wrap; }
        /* Constrain modals and allow scrolling when content is tall */
        .cal-modal-overlay { overflow: auto; }
        .cal-modal { max-height: calc(100vh - 120px); overflow: auto; }
        fieldset {
            padding: 16px 20px;
            border-radius: 14px;
            background: var(--card);
            margin-bottom: 20px
        }

        legend {
            padding: 0 8px;
            font-weight: 600
        }

        label {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 13px;
            margin-bottom: 12px
        }

        input[type=text],
        input[type=number],
        select {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #d4dbe6;
            font-size: 14px
        }

        .row {
            display: flex;
            gap: 18px;
            flex-wrap: wrap
        }

        button {
            cursor: pointer;
            border: none;
            border-radius: 10px;
            padding: 10px 18px;
            font-weight: 600;
            font-size: 14px
        }

        button.primary {
            background: var(--brand);
            color: #fff
        }

        button.ghost {
            background: #fff;
            border: 1px solid #d4dbe6
        }

        /* unified small button size */
        .sm { padding: 6px 12px; font-size: 12px; border-radius: 8px; }

        .actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 10px
        }

        .note {
            font-size: 12px;
            color: #666;
            margin-top: -6px;
            margin-bottom: 14px
        }

        .badge {
            display: inline-block;
            background: var(--brand);
            color: #fff;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 8px
        }
        .card { border:1px solid var(--border); border-radius: 12px; background: var(--card); padding: 10px 12px; }
        .card-head { display:flex; align-items:center; justify-content:flex-end; gap:8px; margin-bottom: 6px; }
        .grid { display:grid; grid-template-columns: 1fr; gap: 16px; }
        @media (min-width: 860px) { .grid { grid-template-columns: 1fr 1fr; } }
    </style>
    
</head>

<body>
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">AI Auto Calendar 设置 <span class="badge">v0.1.0</span></h1>
            <div class="header-actions">
                <button id="save" class="primary">保存</button>
                <button id="btnAuthorizeAll" class="ghost" title="为当前配置的一切地址一次性申请权限">一键授权</button>
            </div>
        </div>

        <!-- 权限提示栏（缺少可选 host 权限时显示） -->
        <div id="permBanner" style="display:none;margin:12px 0;padding:10px 12px;border:1px dashed #eab308;background:#fffbeb;border-radius:10px;color:#854d0e;font-size:13px">
            发现有新配置的服务器或解析服务需要访问权限。为保证正常联网，请点击
            <button id="btnAuthorizeMissing" class="primary sm" style="margin:0 6px">立即授权</button>
            。
        </div>
    
        <fieldset>
            <legend>上传节点（日历服务器）</legend>
            <div class="card">
                <div class="card-head">
                    <button id="addServer" type="button" class="primary sm">新增</button>
                </div>
                <div id="serversEmpty" style="font-size:12px;color:#666">暂无服务器节点，点击“新增”创建。</div>
                <ul id="serverList" style="list-style:none;margin:8px 0 0;padding:0;display:flex;flex-direction:column;gap:8px"></ul>
                <div style="margin-top:8px;font-size:13px">默认服务器：
                    <select id="defaultServerSelect" style="min-width:200px"></select>
                </div>
            </div>
        </fieldset>
    
        <fieldset>
            <legend>解析节点</legend>
            <div class="card">
                <div class="card-head">
                    <button id="addParser" type="button" class="primary sm">新增</button>
                </div>
                <div id="parsersEmpty" style="font-size:12px;color:#666">暂无解析节点，点击“新增”创建。</div>
                <ul id="parserList" style="list-style:none;margin:8px 0 0;padding:0;display:flex;flex-direction:column;gap:8px"></ul>
            </div>
        </fieldset>
    <fieldset>
        <legend>任务列表</legend>
        <div class="card">
            <div class="card-head">
                <button id="runAllTasks" type="button" class="ghost sm" title="运行所有已启用的任务">运行所有任务</button>
                <button id="addPageTask" type="button" class="primary sm">新增任务</button>
            </div>
            <div id="pageTasksEmpty" style="font-size:12px;color:#666">暂无任务，点击“新增任务”创建。</div>
            <ul id="pageTaskList" style="list-style:none;margin:8px 0 0;padding:0;display:flex;flex-direction:column;gap:8px"></ul>
        </div>
    </fieldset>
    <!-- 操作区合并到页头；去除“立即同步”和“最后同步”显示 -->
    <script type="module" src="src/options.js"></script>

        <!-- 新版任务编辑模态 (V3) -->
        <div id="taskModal" class="cal-modal-overlay" style="position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:flex-start;justify-content:center;padding:60px 20px;z-index:9999;backdrop-filter:blur(2px)">
            <div class="cal-modal" style="width:640px;max-width:100%;background:#fff;border-radius:18px;padding:22px 26px;box-shadow:0 6px 34px -8px rgba(0,0,0,.35);display:flex;flex-direction:column;gap:18px;border:1px solid #e6edf5">
                <div style="display:flex;align-items:center;justify-content:space-between">
                    <h2 style="margin:0;font-size:18px;font-weight:650;letter-spacing:.5px;color:#0f172a" id="taskModalTitle">任务</h2>
                    <button id="closeTaskModal" type="button" style="background:#f1f5f9;border:1px solid #d8e2ed;border-radius:8px;padding:6px 14px;cursor:pointer;font-size:13px;font-weight:600;color:#334155">关闭</button>
                </div>
                <form id="taskForm" style="display:flex;flex-direction:column;gap:18px">
                    <div class="row" style="gap:20px;align-items:flex-start">
                        <label style="flex:1;min-width:180px">任务名称
                            <input id="task_name" type="text" required style="margin-top:4px">
                        </label>
                        <label style="flex:1;min-width:180px">日历名称
                            <input id="task_calendarName" type="text" placeholder="ICS 名称" required style="margin-top:4px">
                        </label>
                        <label style="flex:0.6;min-width:120px">启用
                            <select id="task_enabled" style="margin-top:4px"><option value="true">是</option><option value="false">否</option></select>
                        </label>
                    </div>
                    <fieldset class="cal-fieldset" style="border:1px solid #e1e8f0;padding:16px 18px;border-radius:14px;margin:0;display:flex;flex-direction:column;gap:14px;background:#fafcff">
                        <legend style="padding:0 8px;font-size:13px;font-weight:600;color:#0f172a">触发方式（可多选）</legend>
                        <div style="display:flex;flex-direction:column;gap:10px">
                            <label style="display:flex;align-items:center;gap:10px"><input type="checkbox" id="task_useInterval"> 周期(分钟)
                                <input id="task_interval" type="number" min="1" placeholder="间隔分钟" style="margin-left:8px;width:120px">
                            </label>
                            <div>
                                <label style="display:flex;align-items:center;gap:10px"><input type="checkbox" id="task_useTimes"> 指定时间点(HH:mm)</label>
                                <div id="schedule_times_wrap" style="display:none;flex-direction:column;gap:10px;margin-top:6px">
                                    <div id="task_times_list" style="display:flex;gap:8px;flex-wrap:wrap"></div>
                                    <div style="display:flex;gap:10px;flex-wrap:wrap">
                                        <input id="task_time_input" type="text" placeholder="HH:mm" style="flex:1;min-width:140px;padding:8px 10px;border:1px solid #d4dbe6;border-radius:10px;font-size:13px">
                                        <button type="button" id="task_time_add" style="background:#0b74de;color:#fff;padding:8px 16px;border:none;border-radius:10px;font-size:12px;font-weight:600;cursor:pointer">添加时间点</button>
                                    </div>
                                    <div style="font-size:11px;color:#64748b">触发后自动排入下一天同一时间；例如 08:30 / 14:05</div>
                                </div>
                            </div>
                            <div>
                                <label style="display:flex;align-items:center;gap:10px"><input type="checkbox" id="task_visitTrigger"> 访问页面触发</label>
                                <div id="visit_patterns_wrap" style="display:none;flex-direction:column;gap:6px;margin-top:6px">
                                    <label>匹配前缀（每行一条，留空则默认使用目标 URL）
                                        <textarea id="task_visitPatterns" style="margin-top:6px;height:60px;line-height:1.4;font-family:monospace;font-size:12px;padding:8px 10px;border:1px solid #d4dbe6;border-radius:10px;resize:vertical" placeholder="https://my.sjtu.edu.cn/ui/calendar
https://calendar.sjtu.edu.cn/..."></textarea>
                                    </label>
                                    <div style="font-size:11px;color:#64748b">仅主框架导航触发；按 origin+pathname 前缀匹配，忽略 query。</div>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset style="border:1px solid #e1e8f0;padding:16px 18px;border-radius:14px;margin:0;display:flex;flex-direction:column;gap:14px;background:#fafcff">
                        <legend style="padding:0 8px;font-size:13px;font-weight:600;color:#0f172a">数据获取模式</legend>
                        <div style="display:flex;flex-direction:column;gap:14px">
                            <label style="width:220px;font-size:13px">模式
                                <select id="task_mode" style="margin-top:4px"><option value="HTTP_GET_JSON">HTTP_GET_JSON</option></select>
                            </label>
                            <div id="modePanel_HTTP_GET_JSON" style="display:flex;flex-direction:column;gap:14px">
                                <label>目标 URL
                                    <input id="task_url" type="text" required placeholder="https://..." style="margin-top:4px">
                                </label>
                                <label style="width:260px">解析节点（优先）
                                    <select id="task_parserId" style="margin-top:4px"></select>
                                </label>
                                <label style="width:260px">上传服务器
                                    <select id="task_serverId" style="margin-top:4px"></select>
                                </label>
                                <!-- 解析方式由解析节点决定，移除此处的显式选择 -->
                                <label id="task_jsonPaths_wrap" style="display:block">JSON 路径
                                    <textarea id="task_jsonPaths" style="margin-top:6px;height:40px;line-height:1.4;font-family:monospace;font-size:12px;padding:8px 10px;border:1px solid #d4dbe6;border-radius:10px;resize:vertical" placeholder="示例(每行一条):\n# 整个 data: data\n# events 数组本身: data.events\n# events 全部元素: data.events[*]\n# events 第 0 条: data.events[0]\n# 校历 events: data.schoolCalendar.events[*]\n# 多来源分多行"></textarea>
                                </label>
                                <div style="font-size:11px;color:#64748b;line-height:1.55">
                                    说明：每行一条轻量路径（不是完整 JSONPath）。支持 <code>key</code> / <code>key[数字]</code> / <code>key[*]</code> / <code>[数字]</code> / <code>[*]</code> 链式。<br>
                                    展开规则：只有以 <code>[*]</code> 或 <code>[数字]</code> 结尾的路径才会把数组元素逐个加入；否则保留整个数组/对象作为一个片段。<br>
                                    direct 模式：片段中的对象/数组元素若含 <code>title/startTime/endTime</code>（或别名）即尝试识别事件。<br>
                                    LLM 模式：片段集合会序列化为精简 JSON 传给模型，降低噪声。<br>
                                    不支持：条件过滤 / 范围 / 多索引（如 <code>[?()]</code>、<code>[0:5]</code> 等）。<br>
                                    留空：不裁剪（可能上下文冗余大）。
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    <div style="display:flex;gap:14px;justify-content:flex-end;margin-top:4px">
                        <button type="button" id="taskRunOnce" style="background:#fff;border:1px solid #d4dbe6;padding:10px 22px;border-radius:10px;font-weight:600;cursor:pointer;color:#0f172a">试运行</button>
                        <button type="submit" style="background:#0b74de;color:#fff;border:none;padding:10px 28px;border-radius:10px;font-weight:600;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,.15)">保存</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 解析节点编辑模态 -->
        <div id="parserModal" class="cal-modal-overlay" style="position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:flex-start;justify-content:center;padding:60px 20px;z-index:9999;backdrop-filter:blur(2px)">
            <div class="cal-modal" style="width:560px;max-width:100%;background:#fff;border-radius:18px;padding:22px 26px;box-shadow:0 6px 34px -8px rgba(0,0,0,.35);display:flex;flex-direction:column;gap:18px;border:1px solid #e6edf5">
                <div style="display:flex;align-items:center;justify-content:space-between">
                    <h2 style="margin:0;font-size:18px;font-weight:650;letter-spacing:.5px;color:#0f172a" id="parserModalTitle">解析节点</h2>
                    <button id="closeParserModal" type="button" style="background:#f1f5f9;border:1px solid #d8e2ed;border-radius:8px;padding:6px 14px;cursor:pointer;font-size:13px;font-weight:600;color:#334155">关闭</button>
                </div>
                <form id="parserForm" style="display:flex;flex-direction:column;gap:12px">
                    <label>名称<input id="parser_name" type="text" required></label>
                    <label>类型
                        <select id="parser_type">
                            <option value="zhipu_agent">智谱智能体</option>
                            <option value="json_mapping">JSON映射</option>
                        </select>
                    </label>
                    <div id="parser_panel_zhipu" style="display:flex;flex-direction:column;gap:10px">
                        <label>API URL<input id="p_zhipu_apiUrl" type="text" placeholder="https://open.bigmodel.cn/api/llm-application/open/v3/application/invoke" /></label>
                        <label>API Key<input id="p_zhipu_apiKey" type="text" placeholder="Bearer ..." /></label>
                        <label>Agent ID<input id="p_zhipu_agentId" type="text" placeholder="1954810625930809344" /></label>
                        <div class="note">提示语与裁剪已移除：输入数据的筛选在“数据获取阶段”按任务 JSON 路径完成。</div>
                    </div>
                    <div id="parser_panel_jsonmap" style="display:none;flex-direction:column;gap:10px">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                            <label>标题字段(逗号分隔)<input id="p_json_map_title" type="text" placeholder="title,summary,name" /></label>
                            <label>地点字段(逗号分隔)<input id="p_json_map_location" type="text" placeholder="location,place" /></label>
                            <label>开始时间字段(逗号分隔)<input id="p_json_map_startTime" type="text" placeholder="startTime,begin,start" /></label>
                            <label>结束时间字段(逗号分隔)<input id="p_json_map_endTime" type="text" placeholder="endTime,finish,end" /></label>
                            <label>UID 字段(逗号分隔)<input id="p_json_map_uid" type="text" placeholder="uid,id,eventId" /></label>
                            <label>描述字段(逗号分隔)<input id="p_json_map_description" type="text" placeholder="description,desc,detail" /></label>
                        </div>
                        <fieldset style="border:1px solid #e1e8f0;padding:12px;border-radius:10px;background:#f8fafc">
                            <legend style="padding:0 6px;font-size:12px;color:#0f172a">默认值(当字段缺失时使用)</legend>
                            <div class="row" style="gap:10px;flex-wrap:wrap">
                                <label style="min-width:180px">标题默认值<input id="p_json_def_title" type="text" placeholder="(可选)" /></label>
                                <label style="min-width:180px">地点默认值<input id="p_json_def_location" type="text" placeholder="(可选)" /></label>
                                <label style="min-width:180px">开始时间默认值<input id="p_json_def_startTime" type="text" placeholder="(可选)" /></label>
                                <label style="min-width:180px">结束时间默认值<input id="p_json_def_endTime" type="text" placeholder="(可选)" /></label>
                                <label style="min-width:180px">UID 默认值<input id="p_json_def_uid" type="text" placeholder="auto | 固定字符串" /></label>
                                <label style="min-width:180px">描述默认值<input id="p_json_def_description" type="text" placeholder="(可选)" /></label>
                            </div>
                            <div class="note">UID 默认值填 <code>auto</code> 时将自动生成；留空则当字段缺失时跳过。</div>
                        </fieldset>
                        <div style="font-size:12px;color:#64748b">时间字段支持多种格式，内部会尝试解析。</div>
                    </div>
                    <div style="display:flex;gap:10px;justify-content:flex-end"><button type="submit" class="primary">保存</button></div>
                </form>
            </div>
        </div>

        <!-- 服务器节点编辑模态 -->
        <div id="serverModal" class="cal-modal-overlay" style="position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:flex-start;justify-content:center;padding:60px 20px;z-index:9999;backdrop-filter:blur(2px)">
            <div class="cal-modal" style="width:560px;max-width:100%;background:#fff;border-radius:18px;padding:22px 26px;box-shadow:0 6px 34px -8px rgba(0,0,0,.35);display:flex;flex-direction:column;gap:18px;border:1px solid #e6edf5">
                <div style="display:flex;align-items:center;justify-content:space-between">
                    <h2 style="margin:0;font-size:18px;font-weight:650;letter-spacing:.5px;color:#0f172a" id="serverModalTitle">服务器节点</h2>
                    <button id="closeServerModal" type="button" style="background:#f1f5f9;border:1px solid #d8e2ed;border-radius:8px;padding:6px 14px;cursor:pointer;font-size:13px;font-weight:600;color:#334155">关闭</button>
                </div>
                <form id="serverForm" style="display:flex;flex-direction:column;gap:12px">
                    <label>名称<input id="server_name" type="text" required></label>
                    <label>类型
                        <select id="server_type">
                            <option value="radicale">Radicale</option>
                            <option value="google">Google 日历</option>
                        </select>
                    </label>
                    <div id="server_panel_radicale" style="display:flex;flex-direction:column;gap:10px">
                        <label>Base URL<input id="s_radicale_base" type="text" placeholder="http://127.0.0.1:5232" /></label>
                        <label>用户名<input id="s_radicale_username" type="text" placeholder="user" /></label>
                        <label>Authorization(可选)<input id="s_radicale_auth" type="text" placeholder="Basic ..." /></label>
                    </div>
                    <div id="server_panel_google" style="display:none;flex-direction:column;gap:10px">
                        <label>OAuth Client ID<input id="s_google_clientId" type="text" placeholder="xxxxxxxx.apps.googleusercontent.com" /></label>
                        <label>OAuth Client Secret（可选）<input id="s_google_clientSecret" type="text" placeholder="(可选)" /></label>
                        <label>Calendar ID<input id="s_google_calendarId" type="text" placeholder="primary 或 someone@gmail.com" /></label>
                        <div class="note">授权前请在 Google Cloud 控制台的 OAuth 同意屏幕与凭据中，将重定向 URI 添加为：<code id="google_redirect_hint"></code></div>
                        <div style="display:flex;gap:10px;align-items:center">
                          <button id="btnGoogleAuthorize" type="button" class="ghost">Google 授权</button>
                          <span id="googleAuthStatus" style="font-size:12px;color:#64748b"></span>
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;justify-content:flex-end"><button type="submit" class="primary">保存</button></div>
                </form>
            </div>
        </div>

        <!-- 任务日志面板 -->
        <hr>
        <section id="logs-section" style="margin-top: 16px;">
            <h2 style="margin: 8px 0;">任务日志</h2>
            <div style="display:flex; align-items:center; gap:8px; flex-wrap: wrap; margin-bottom: 8px;">
                <label for="log-limit">显示条数</label>
                <select id="log-limit">
                    <option value="100">100</option>
                    <option value="200" selected>200</option>
                    <option value="500">500</option>
                    <option value="1000">1000</option>
                </select>
                <button id="btn-refresh-logs">刷新</button>
                <button id="btn-clear-logs">清空</button>
            </div>
            <div id="logs-container" style="max-height: 300px; overflow: auto; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 12px; background: #fafafa;"></div>
        </section>
    </div>
</body>

</html>